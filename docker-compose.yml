version: '3.8'

services:
  # 1. 数据库服务 (保持你原有的配置，稍作优化)
  postgres:
    image: pgvector/pgvector:pg16
    container_name: scholar-ai-postgres
    environment:
      POSTGRES_DB: scholar_ai_db
      POSTGRES_USER: scholar_user
      POSTGRES_PASSWORD: scholar_password
      POSTGRES_INITDB_ARGS: "-E UTF8"
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    networks:
      - scholar-ai-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U scholar_user -d scholar_ai_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 2. [新增] Java 开发环境服务 (你的隔离核心)
  backend:
    # 直接使用官方 Maven + JDK 21 镜像，无需自己写 Dockerfile
    image: maven:3.9-eclipse-temurin-21
    container_name: scholar-ai-backend
    # 让容器保持运行，充当一台“虚拟开发机”
    command: mvn spring-boot:run -Dspring-boot.run.jvmArguments="-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005"
    working_dir: /app
    ports:
      - "8080:8080"  # 暴露 Web 端口
      - "5005:5005"  # 暴露远程调试端口 (Debug用)
    volumes:
      # A. 代码挂载：你在本机改代码，容器里立即生效
      - .:/app
      # B. 仓库隔离：所有的 jar 包都会下载到项目目录下的 .mvn_repo 文件夹
      # 这样绝对不会污染你本机的其他项目！
      - ./.mvn_repo:/root/.m2/repository
    environment:
      # 覆盖 application.yml 里的 localhost，改为服务名 postgres
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/scholar_ai_db
      - SPRING_DATASOURCE_USERNAME=scholar_user
      - SPRING_DATASOURCE_PASSWORD=scholar_password
      # 请记得在这里填入你的 API Key，或者在运行命令时传入
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - scholar-ai-network

  # 3. 数据库管理工具 (保留)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: scholar-ai-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@scholar-ai.local
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"
    networks:
      - scholar-ai-network
    depends_on:
      - postgres

volumes:
  postgres_data:
    driver: local

networks:
  scholar-ai-network:
    driver: bridge
